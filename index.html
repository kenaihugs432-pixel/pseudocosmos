<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AR com WebXR — pseudocosmos</title>
  <style>
    body{margin:0;overflow:hidden;font-family:sans-serif;background:#000;color:#fff}
    #message{position:fixed;left:10px;top:10px;z-index:20;background:#fff;color:#000;padding:8px;border-radius:6px;box-shadow:0 2px 10px rgba(0,0,0,.2);max-width:calc(100% - 24px)}
    #errorBox{position:fixed;left:10px;bottom:10px;right:10px;z-index:21;background:rgba(0,0,0,0.8);color:#fff;padding:10px;border-radius:6px;display:none;max-height:40vh;overflow:auto;font-family:monospace;font-size:13px}
    canvas {width:100%;height:100%}
    a{color:blue}
  </style>
</head>
<body>
  <div id="message">Iniciando AR… (se ficar em branco, abra o console do navegador)</div>
  <div id="errorBox"></div>

  <script type="module">
  (async function(){
    const showError = (txt) => {
      const box = document.getElementById('errorBox');
      box.style.display = 'block';
      box.textContent += txt + "\n\n";
      console.error(txt);
    };

    // check GLB exists
    try {
      const resp = await fetch('aha.glb', {method:'HEAD'});
      if(!resp.ok){
        showError('Erro: não encontrei "aha.glb" na raiz do site. Verifique o nome (case-sensitive). HTTP ' + resp.status);
        document.getElementById('message').innerHTML = 'Arquivo GLB não encontrado. Abra <a href="index_modelviewer.html">fallback model-viewer</a>.';
        return;
      }
    } catch(e) {
      showError('Erro ao checar aha.glb: ' + e);
      document.getElementById('message').innerHTML = 'Erro de rede ao verificar model. Abra <a href="index_modelviewer.html">fallback model-viewer</a>.';
      return;
    }

    // IMPORTS com CDN (paths absolutos)
    let THREE, GLTFLoader, ARButton;
    try {
      THREE = await import('https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.module.js');
      const gltfMod = await import('https://cdn.jsdelivr.net/npm/three@0.154.0/examples/jsm/loaders/GLTFLoader.js');
      const arMod = await import('https://cdn.jsdelivr.net/npm/three@0.154.0/examples/jsm/webxr/ARButton.js');
      GLTFLoader = gltfMod.GLTFLoader;
      ARButton = arMod.ARButton;
    } catch(err) {
      showError('Falha ao carregar Three.js via CDN: ' + err);
      document.getElementById('message').innerHTML = 'WebXR não disponível aqui. Abra o <a href="index_modelviewer.html">fallback (model-viewer)</a>.';
      return;
    }

    try {
      const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.body.appendChild(renderer.domElement);

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 20);
      const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
      scene.add(light);

      const ring = new THREE.RingGeometry(0.07, 0.09, 32).rotateX(-Math.PI/2);
      const ringMat = new THREE.MeshBasicMaterial({color:0x00ffcc});
      const reticle = new THREE.Mesh(ring, ringMat);
      reticle.matrixAutoUpdate = false;
      reticle.visible = false;
      scene.add(reticle);

      const loader = new GLTFLoader();
      let modelGLB = null;
      loader.load('aha.glb', (g) => {
        modelGLB = g.scene;
        modelGLB.scale.set(0.5,0.5,0.5);
        document.getElementById('message').textContent = 'Modelo carregado — toque "Enter AR" (Chrome Android).';
      }, undefined, (err) => {
        showError('Erro carregando aha.glb: ' + err);
        document.getElementById('message').innerHTML = 'Erro no carregamento do modelo. Abra <a href="index_modelviewer.html">fallback</a>.';
      });

      document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));

      const controller = renderer.xr.getController(0);
      controller.addEventListener('select', () => {
        if(!modelGLB || !reticle.visible) return;
        const clone = modelGLB.clone(true);
        clone.position.setFromMatrixPosition(reticle.matrix);
        clone.quaternion.setFromRotationMatrix(reticle.matrix);
        scene.add(clone);
      });
      scene.add(controller);

      const tempMatrix = new THREE.Matrix4();
      renderer.setAnimationLoop((timestamp, frame) => {
        if(frame){
          const session = renderer.xr.getSession();
          const referenceSpace = renderer.xr.getReferenceSpace();
          if(!session._hitTestSourceRequested){
            session._hitTestSourceRequested = true;
            session.requestReferenceSpace('viewer').then(viewerSpace => {
              session.requestHitTestSource({ space: viewerSpace }).then(src => session._hitTestSource = src)
                .catch(e => console.warn('requestHitTestSource failed', e));
            }).catch(e => console.warn('requestReferenceSpace failed', e));
          }
          const hitTestSource = session._hitTestSource;
          if(hitTestSource){
            const hitTestResults = frame.getHitTestResults(hitTestSource);
            if(hitTestResults.length > 0){
              const hit = hitTestResults[0];
              const pose = hit.getPose(referenceSpace);
              tempMatrix.fromArray(pose.transform.matrix);
              reticle.matrix.copy(tempMatrix);
              reticle.visible = true;
            } else reticle.visible = false;
          }
        }
        renderer.render(scene, camera);
      });

      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    } catch(e){
      showError('Erro durante inicialização WebXR: ' + e);
      document.getElementById('message').innerHTML = 'Erro de inicialização. Abra <a href="index_modelviewer.html">fallback</a>.';
    }

  })();
  </script>
</body>
</html>
